CREATE
	OR REPLACE VIEW ORDER_DB.ORDER__XFRM.V_CUSTOMER_1 AS
	WITH OrderDetails AS (
			SELECT CUSTOMER_ID
				,COUNT(ITEM_ID) AS TOTAL_ORDERS
			FROM ORDER_DB.ORDER__XFRM.V_SALES_ORDER_DETAIL
			GROUP BY CUSTOMER_ID
			)

SELECT DISTINCT c.CUSTOMER_ID
	,c.ADDRESS
	,c.PHONE_NO
	,c.CATEGORY
	,c.STATUS
	,COALESCE(od.TOTAL_ORDERS, 0) AS TOTAL_ORDERS
	,c.TOTAL_INVOICE_AMOUNT
	,CASE 
		WHEN oh.COUPON_CODE ilike 'SPENT'
			AND c.CATEGORY ilike 'GOLD'
			THEN 100
		WHEN oh.COUPON_CODE ilike 'SPENT'
			AND c.CATEGORY ilike 'SILVER'
			THEN 50
		WHEN oh.COUPON_CODE ilike 'SPENT'
			AND c.CATEGORY ilike 'BRONZE'
			THEN 30
		ELSE 0
		END AS LOYALTY_POINTS
	,c.CREATE_DATE
	,c.CREATE_USER
FROM ORDER_DB.ORDER__XFRM.V_CUSTOMER c
LEFT JOIN OrderDetails od ON c.CUSTOMER_ID = od.CUSTOMER_ID
LEFT JOIN ORDER_DB.ORDER__BASE.T_SALES_ORDER_HEADER oh ON c.CUSTOMER_ID = oh.CUSTOMER_ID
ORDER BY c.CUSTOMER_ID;