CREATE
	OR REPLACE VIEW ORDER_DB.ORDER__XFRM.V_SALES_ORDER_HEADER AS
	WITH OrderDetails AS (
			SELECT ORDER_ID
				,SUM(QTY) AS ITEM_COUNT
				,SUM(TOTAL_AMOUNT) AS TOTAL_AMOUNT
			FROM ORDER_DB.ORDER__XFRM.V_SALES_ORDER_DETAIL
			GROUP BY ORDER_ID
			)

SELECT DISTINCT oh.ORDER_ID
	,oh.ORDER_DATE
	,oh.STATUS
	,oh.CUSTOMER_ID
	,od.ITEM_COUNT
	,od.TOTAL_AMOUNT
	,CASE 
		WHEN oh.COUPON_CODE ilike '%PERCENT%'
			AND c.CATEGORY ilike '%GOLD%'
			THEN 5
		WHEN oh.COUPON_CODE ilike '%PERCENT%'
			AND c.CATEGORY ilike '%SILVER%'
			THEN 3
		WHEN oh.COUPON_CODE ilike '%PERCENT%'
			AND c.CATEGORY ilike '%BRONZE%'
			THEN 1
		ELSE 0
		END AS DISCOUNT
	,oh.CREATE_DATE
	,oh.CREATE_USER
	,oh.COUPON_CODE
FROM ORDER_DB.ORDER__BASE.T_SALES_ORDER_HEADER oh
JOIN ORDER_DB.ORDER__XFRM.V_CUSTOMER c ON oh.CUSTOMER_ID = c.CUSTOMER_ID
JOIN OrderDetails od ON oh.ORDER_ID = od.ORDER_ID
ORDER BY ORDER_ID;